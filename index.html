<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silent Orbit - Mission Control</title>
    <style>
        /* --- å®‡å®™èˆ¹ã‚¹ã‚¿ã‚¤ãƒ« --- */
        body { background-color: #0d0d15; color: #0f0; font-family: 'Courier New', monospace; text-align: center; margin: 0; padding: 10px; }
        h1, h2, h3 { margin: 5px 0; text-shadow: 0 0 5px #0f0; }
        .hidden { display: none !important; }
        
        /* æ ç·šã¨ãƒ‘ãƒãƒ« */
        .panel { border: 2px solid #0f0; border-radius: 10px; padding: 10px; margin: 10px auto; max-width: 600px; background: rgba(0, 50, 0, 0.3); }
        .hud-value { font-size: 1.5em; font-weight: bold; color: #fff; }
        
        /* ãƒœã‚¿ãƒ³ */
        button { background: #003300; color: #0f0; border: 1px solid #0f0; padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 5px; border-radius: 5px; transition: 0.2s; }
        button:hover { background: #005500; box-shadow: 0 0 10px #0f0; }
        button:disabled { border-color: #555; color: #555; background: #111; cursor: not-allowed; box-shadow: none; }
        .btn-reset { border-color: red; color: red; background: #300; }
        .btn-reset:hover { background: #500; box-shadow: 0 0 10px red; }

        /* ã‚µã‚¤ã‚³ãƒ­ */
        .dice-container { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
        .dice { width: 50px; height: 50px; line-height: 50px; border: 2px solid #0f0; font-size: 24px; font-weight: bold; background: #000; cursor: pointer; }
        .dice.selected { background: #0f0; color: #000; box-shadow: 0 0 15px #0f0; }
        .dice.used { border-color: #555; color: #555; cursor: default; }

        /* ã‚¹ãƒ­ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        .slot-area { display: flex; justify-content: space-around; flex-wrap: wrap; }
        .slot-box { border: 1px dashed #0f0; padding: 10px; width: 30%; min-width: 100px; margin: 5px; }
        .slot-val { font-size: 20px; color: #fff; }
    </style>
</head>
<body>

    <div id="lobby-screen">
        <h1>SILENT ORBIT</h1>
        <p>Mission Status: WAITING</p>
        <div class="panel">
            <h3>SELECT ROLE</h3>
            <button onclick="tryJoin('pilot')">ğŸ‘¨â€ğŸš€ æ“ç¸¦å£« (Pilot)</button>
            <button onclick="tryJoin('engineer')">ğŸ”§ æ©Ÿé–¢å£« (Engineer)</button>
        </div>
        <div class="panel" style="border-color: #555;">
            <button onclick="joinAudience()">ğŸ‘€ è¦³æˆ¦ãƒ¢ãƒ‹ã‚¿ãƒ¼</button>
            <button onclick="joinSV()" style="color: yellow; border-color: yellow;">ğŸ‘‘ SV Menu</button>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div style="display:flex; justify-content:space-between; padding:0 10px;">
            <span>Role: <span id="my-role-name" style="font-weight:bold;">--</span></span>
            <button id="sv-reset-btn" class="hidden btn-reset" onclick="sendReset()">âš  EMERGENCY RESET</button>
        </div>

        <div class="panel" style="display:flex; justify-content:space-around;">
            <div>â›½ FUEL<br><span id="hud-fuel" class="hud-value">-</span></div>
            <div>ğŸš€ DIST<br><span id="hud-dist" class="hud-value">-</span></div>
            <div>ğŸ›¡ SHIELD<br><span id="hud-shield" class="hud-value">-</span></div>
        </div>

        <div class="panel">
            <div id="msg-box" style="height:20px; color:yellow;">é€šä¿¡å¾…æ©Ÿä¸­...</div>

            <div id="area-pilot">
                <h3>PILOT DECK</h3>
                <div id="pilot-dice-container" class="dice-container"></div>
                <button id="btn-roll-pilot" onclick="rollDice('pilot')" disabled>ğŸ² ROLL DICE</button>
            </div>

            <hr style="border-color:#030;">

            <div id="area-engineer">
                <h3>ENGINEER DECK</h3>
                <div id="eng-dice-container" class="dice-container"></div>
                <button id="btn-roll-eng" onclick="rollDice('engineer')" disabled>ğŸ² ROLL DICE</button>
            </div>
        </div>

        <div class="panel">
            <h3>SYSTEM SLOTS</h3>
            <div class="slot-area">
                <div class="slot-box">
                    <div>ğŸš€ THRUSTER</div>
                    <div id="slot-move-val" class="slot-val">0</div>
                    <button id="btn-place-move" onclick="placeDice('move')" disabled>SET</button>
                </div>
                <div class="slot-box">
                    <div>âš¡ REACTOR</div>
                    <div id="slot-energy-val" class="slot-val">0</div>
                    <button id="btn-place-energy" onclick="placeDice('energy')" disabled>SET</button>
                </div>
                <div class="slot-box">
                    <div>ğŸ”§ REPAIR</div>
                    <div id="slot-shield-val" class="slot-val">0</div>
                    <button id="btn-place-shield" onclick="placeDice('shield')" disabled>SET</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // â˜…â˜…â˜… ã“ã“ã« GASã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URL ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â˜…â˜…â˜…
        const API_URL = 'https://script.google.com/macros/s/AKfycbyOkcgU8ko-43RWPUr0MrSwISwyNhBo46TaO2WTfQ4KE8rwUSKdkJHRzrvgdr1YF1XP/exec';
        // =================================================================

        let myRole = ''; // pilot, engineer, supervisor, audience
        let selectedDiceValue = 0; // ä»Šé¸ã‚“ã§ã„ã‚‹ã‚µã‚¤ã‚³ãƒ­ã®å€¤
        let pollingInterval = null;

        // --- 1. å‚åŠ å‡¦ç† ---
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦å‚åŠ ï¼ˆæ—©ã„è€…å‹ã¡ãƒã‚§ãƒƒã‚¯ï¼‰
        async function tryJoin(role) {
            showMessage("ã‚¹ãƒ­ãƒƒãƒˆç¢ºèªä¸­...");
            const res = await sendData({ action: 'join', role: role });
            
            if (res.result === 'success') {
                startGame(role);
            } else {
                alert("ãã®å¸­ã¯æ—¢ã«åŸ‹ã¾ã£ã¦ã„ã¾ã™ï¼è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œã—ã¾ã™ã€‚");
                startGame('audience');
            }
        }

        // è¦³æˆ¦è€…ã¨ã—ã¦å‚åŠ 
        function joinAudience() {
            startGame('audience');
        }

        // SVã¨ã—ã¦å‚åŠ ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ï¼‰
        function joinSV() {
            const pw = prompt("ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›:");
            if (pw === "1234") {
                startGame('supervisor');
            } else {
                alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
            }
        }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆã¨ãƒ«ãƒ¼ãƒ—é–‹å§‹
        function startGame(role) {
            myRole = role;
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            // å½¹å‰²åè¡¨ç¤º
            const names = { 'pilot': 'PILOT', 'engineer': 'ENGINEER', 'supervisor': 'SUPERVISOR', 'audience': 'OBSERVER' };
            document.getElementById('my-role-name').innerText = names[role];
            document.getElementById('my-role-name').style.color = (role === 'supervisor') ? 'yellow' : '#0f0';

            // SVãƒœã‚¿ãƒ³è¡¨ç¤º
            if (role === 'supervisor') {
                document.getElementById('sv-reset-btn').classList.remove('hidden');
            }

            // é€šä¿¡é–‹å§‹ (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯1ç§’ã€è¦³æˆ¦è€…ã¯3ç§’é–“éš”ã§è² è·è»½æ¸›)
            const intervalTime = (role === 'audience') ? 3000 : 1000;
            updateScreen(); // åˆå›å®Ÿè¡Œ
            pollingInterval = setInterval(updateScreen, intervalTime);
        }

        // --- 2. ã‚²ãƒ¼ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---

        // ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹
        async function rollDice(targetRole) {
            if (myRole !== targetRole && myRole !== 'supervisor') return; // è‡ªåˆ†ã®ç•ªä»¥å¤–ã¯ç„¡è¦–
            showMessage("ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦ã„ã¾ã™...");
            await sendData({ action: 'roll', role: targetRole });
            updateScreen();
        }

        // ã‚µã‚¤ã‚³ãƒ­ã‚’é¸ã¶ (ã‚¯ãƒªãƒƒã‚¯æ™‚)
        function selectDice(val, element) {
            if (val === 0) return; // 0ã¯ç©º
            
            // é¸æŠçŠ¶æ…‹ã®è¦‹ãŸç›®åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.dice').forEach(d => d.classList.remove('selected'));
            element.classList.add('selected');
            
            selectedDiceValue = val;
            showMessage(`å€¤ [ ${val} ] ã‚’é¸æŠä¸­ã€‚é…ç½®å…ˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚`);
            
            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ– (å½¹å‰²ã«å¿œã˜ã¦åˆ¶é™)
            updateButtonState();
        }

        // ã‚µã‚¤ã‚³ãƒ­ã‚’ã‚¹ãƒ­ãƒƒãƒˆã«ç½®ã
        async function placeDice(slotName) {
            if (selectedDiceValue === 0) return;
            
            showMessage("é…ç½®ä¸­...");
            await sendData({ action: 'place', slot: slotName, value: selectedDiceValue });
            
            selectedDiceValue = 0; // é¸æŠè§£é™¤
            updateScreen();
        }

        // ãƒªã‚»ãƒƒãƒˆ (SVã®ã¿)
        async function sendReset() {
            if (!confirm("æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿå…¨å“¡ã®ã‚²ãƒ¼ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚")) return;
            showMessage("ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œä¸­...");
            await sendData({ action: 'reset' });
            updateScreen();
        }

        // --- 3. ç”»é¢æ›´æ–° (ãƒãƒ¼ãƒªãƒ³ã‚°) ---
        async function updateScreen() {
            try {
                // ä½•ã‚‚é€ã‚‰ãšã«GETã™ã‚‹ã¨æœ€æ–°çŠ¶æ…‹ãŒè¿”ã£ã¦ãã‚‹
                const res = await fetch(API_URL).then(r => r.json());
                const s = res.state;

                // HUDæ›´æ–°
                document.getElementById('hud-fuel').innerText = s.fuel;
                document.getElementById('hud-dist').innerText = s.distance;
                document.getElementById('hud-shield').innerText = s.shield;

                // ã‚¹ãƒ­ãƒƒãƒˆæ›´æ–°
                document.getElementById('slot-move-val').innerText = s.slot_move;
                document.getElementById('slot-energy-val').innerText = s.slot_energy;
                document.getElementById('slot-shield-val').innerText = s.slot_shield;

                // ã‚µã‚¤ã‚³ãƒ­æç”»
                renderDice('pilot', s.p_dice);
                renderDice('engineer', s.e_dice);

                // ãƒœã‚¿ãƒ³åˆ¶å¾¡ (è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã‹ï¼Ÿ)
                updateButtonState();
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if(document.getElementById('msg-box').innerText === "é€šä¿¡å¾…æ©Ÿä¸­...") {
                     showMessage("ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸ç¨¼åƒä¸­");
                }

            } catch (e) {
                console.error(e);
                showMessage("é€šä¿¡ã‚¨ãƒ©ãƒ¼: å†æ¥ç¶šä¸­...");
            }
        }

        // ã‚µã‚¤ã‚³ãƒ­ã‚’æç”»ã™ã‚‹é–¢æ•°
        function renderDice(role, diceArray) {
            const container = (role === 'pilot') ? document.getElementById('pilot-dice-container') : document.getElementById('eng-dice-container');
            container.innerHTML = ''; // ã‚¯ãƒªã‚¢

            diceArray.forEach(val => {
                const div = document.createElement('div');
                div.className = 'dice';
                div.innerText = val === 0 ? '-' : val;
                
                // ã™ã§ã«ä½¿ç”¨æ¸ˆã¿(0)ãªã‚‰è–„ã
                if (val === 0) div.classList.add('used');

                // è‡ªåˆ†ã®ã‚µã‚¤ã‚³ãƒ­ãªã‚‰ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«
                if (myRole === role && val !== 0) {
                    div.onclick = function() { selectDice(val, div); };
                }
                container.appendChild(div);
            });
        }

        // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹ãƒ»ç„¡åŠ¹ã‚’ç®¡ç†
        function updateButtonState() {
            // ROLLãƒœã‚¿ãƒ³: è‡ªåˆ†ãŒãã®å½¹å‰²ãªã‚‰æŠ¼ã›ã‚‹
            document.getElementById('btn-roll-pilot').disabled = (myRole !== 'pilot');
            document.getElementById('btn-roll-eng').disabled = (myRole !== 'engineer');

            // é…ç½®ãƒœã‚¿ãƒ³: ã‚µã‚¤ã‚³ãƒ­ã‚’é¸ã‚“ã§ãªã„ã¨æŠ¼ã›ãªã„ + å½¹å‰²åˆ¶é™
            const hasSelected = (selectedDiceValue !== 0);
            
            // æ“ç¸¦å£«ã¯ã€Œç§»å‹•ã€ã®ã¿
            document.getElementById('btn-place-move').disabled = !(hasSelected && myRole === 'pilot');
            
            // æ©Ÿé–¢å£«ã¯ã€Œã‚¨ãƒãƒ«ã‚®ãƒ¼ã€ã€Œä¿®ç†ã€ã®ã¿
            document.getElementById('btn-place-energy').disabled = !(hasSelected && myRole === 'engineer');
            document.getElementById('btn-place-shield').disabled = !(hasSelected && myRole === 'engineer');
        }

        // æ±ç”¨: ãƒ‡ãƒ¼ã‚¿é€ä¿¡
        async function sendData(params) {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½œæˆ (?action=join&role=pilot...)
            const qs = new URLSearchParams(params).toString();
            const res = await fetch(API_URL + '?' + qs).then(r => r.json());
            return res;
        }

        function showMessage(msg) {
            document.getElementById('msg-box').innerText = msg;
        }
    </script>
</body>
</html>

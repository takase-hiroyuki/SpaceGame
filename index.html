<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silent Orbit</title>
    <style>
        body { background-color: #050510; color: #0f0; font-family: 'Courier New', monospace; text-align: center; margin: 0; padding: 10px; user-select: none; }
        h1, h2 { margin: 5px 0; text-shadow: 0 0 5px #0f0; }
        .hidden { display: none !important; }
        .panel { border: 1px solid #0f0; border-radius: 8px; padding: 10px; margin: 10px auto; max-width: 600px; background: rgba(0, 30, 0, 0.4); }
        
        /* HUD */
        .hud-container { display: flex; justify-content: space-around; background: #001100; padding: 10px; border-bottom: 2px solid #0f0; }
        .hud-box { text-align: center; width: 30%; }
        .hud-label { font-size: 12px; color: #8f8; }
        .hud-val { font-size: 24px; font-weight: bold; color: #fff; }

        /* „Éú„Çø„É≥ */
        button { background: #003300; color: #0f0; border: 1px solid #0f0; padding: 10px; font-size: 16px; cursor: pointer; border-radius: 4px; margin: 5px; }
        button:disabled { border-color: #444; color: #444; background: #111; }
        .btn-engage { background: #006600; color: #fff; font-weight: bold; width: 80%; padding: 15px; font-size: 20px; box-shadow: 0 0 10px #0f0; }
        .btn-engage:hover { background: #00aa00; }
        
        /* „ÉÄ„Ç§„Çπ */
        .dice-area { display: flex; justify-content: center; gap: 8px; margin: 10px 0; min-height: 50px; }
        .dice { width: 45px; height: 45px; line-height: 45px; border: 2px solid #0f0; font-size: 22px; background: #000; cursor: pointer; }
        .dice.selected { background: #0f0; color: #000; box-shadow: 0 0 10px #0f0; }
        .dice.used { border-color: #333; color: #333; cursor: default; }

        /* „Çπ„É≠„ÉÉ„Éà */
        .slot-row { display: flex; justify-content: space-around; margin-top: 10px; }
        .slot { border: 1px dashed #0a0; padding: 5px; width: 30%; min-height: 80px; position: relative; }
        .slot-title { font-size: 12px; color: #8f8; margin-bottom: 5px; }
        .slot-val { font-size: 28px; color: #fff; font-weight: bold; }
        .slot button { width: 90%; font-size: 12px; padding: 5px; }

    </style>
</head>
<body>

    <div id="lobby" class="panel">
        <h1>SILENT ORBIT</h1>
        <p>COOPERATIVE SPACE MISSION</p>
        <hr style="border-color:#030;">
        <button onclick="join('pilot')">üë®‚ÄçüöÄ PILOT</button>
        <button onclick="join('engineer')">üîß ENGINEER</button>
        <br><br>
        <button onclick="join('supervisor')">üëë SUPERVISOR (PW)</button>
        <button onclick="join('audience')">üëÄ MONITOR</button>
    </div>

    <div id="game" class="hidden">
        <div class="hud-container">
            <div class="hud-box"><div class="hud-label">FUEL</div><div id="val-fuel" class="hud-val">5</div></div>
            <div class="hud-box"><div class="hud-label">DIST</div><div id="val-dist" class="hud-val">0</div></div>
            <div class="hud-box"><div class="hud-label">SHIELD</div><div id="val-shield" class="hud-val">3</div></div>
        </div>

        <div style="font-size:12px; text-align:right; color:#888; padding:2px;">
            ROLE: <span id="disp-role" style="color:#fff; font-weight:bold;">-</span>
        </div>

        <div class="panel">
            <div style="text-align:left; color:#0f0;">‚ñ† PILOT DECK</div>
            <div id="p-dice-area" class="dice-area"></div>
            <button id="btn-roll-p" onclick="act('roll', {role:'pilot'})" disabled>üé≤ ROLL</button>

            <hr style="border-color:#030; margin:15px 0;">

            <div style="text-align:left; color:#0f0;">‚ñ† ENGINEER DECK</div>
            <div id="e-dice-area" class="dice-area"></div>
            <button id="btn-roll-e" onclick="act('roll', {role:'engineer'})" disabled>üé≤ ROLL</button>
        </div>

        <div class="panel">
            <div style="color:#ff0; font-size:14px; margin-bottom:5px;">SYSTEM SLOTS</div>
            <div class="slot-row">
                <div class="slot">
                    <div class="slot-title">üöÄ THRUSTER</div>
                    <div id="slot-move" class="slot-val">0</div>
                    <button id="btn-set-move" onclick="place('move')" disabled>SET</button>
                </div>
                <div class="slot">
                    <div class="slot-title">‚ö° REACTOR</div>
                    <div id="slot-energy" class="slot-val">0</div>
                    <button id="btn-set-energy" onclick="place('energy')" disabled>SET</button>
                </div>
                <div class="slot">
                    <div class="slot-title">üõ° REPAIR</div>
                    <div id="slot-shield" class="slot-val">0</div>
                    <button id="btn-set-shield" onclick="place('shield')" disabled>SET</button>
                </div>
            </div>
        </div>

        <div id="area-engage" class="panel hidden" style="border-color:yellow;">
            <p style="color:yellow; font-size:12px; margin:0;">SYSTEM READY</p>
            <button class="btn-engage" onclick="resolveTurn()">üöÄ ENGAGE (Áô∫ÈÄ≤)</button>
        </div>

        <button id="btn-reset" class="hidden" onclick="act('reset')" style="background:#500; color:#faa; width:100%;">‚ö† EMERGENCY RESET</button>
    </div>

    <script>
        // ‚òÖ‚òÖ‚òÖ „Åì„Åì„Å´GAS„ÅÆURL„ÇíË≤º„Çã ‚òÖ‚òÖ‚òÖ
        const API = 'https://script.google.com/macros/s/xxxxxxxxxxxxxxxxxxxx/exec';
        // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ

        let myRole = '';
        let selectedVal = 0;
        let lockUpdate = false;

        async function join(role) {
            if (role === 'supervisor') {
                if (prompt("Password?") !== "1234") return;
            }
            // ÂèÇÂä†„É™„ÇØ„Ç®„Çπ„Éà
            if (role === 'pilot' || role === 'engineer') {
                const res = await fetch(API + '?action=join&role=' + role).then(r=>r.json());
                if (res.result === 'taken') { alert("Ê∫ÄÂ∏≠„Åß„Åô"); role = 'audience'; }
            }
            
            myRole = role;
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            document.getElementById('disp-role').innerText = role.toUpperCase();
            
            if (role === 'supervisor') document.getElementById('btn-reset').classList.remove('hidden');

            setInterval(update, 2000); // 2Áßí„Åî„Å®„Å´Êõ¥Êñ∞
            update();
        }

        // Ê±éÁî®„Ç¢„ÇØ„Ç∑„Éß„É≥ÈÄÅ‰ø°
        async function act(action, params = {}) {
            lockUpdate = true; // ÈÄö‰ø°‰∏≠„ÅØÊõ¥Êñ∞„É≠„ÉÉ„ÇØ
            const qs = new URLSearchParams({ ...params, action: action }).toString();
            await fetch(API + '?' + qs);
            lockUpdate = false;
            update();
        }

        // ÈÖçÁΩÆÂá¶ÁêÜ
        function place(slotName) {
            if (selectedVal === 0) return;
            act('place', { slot: slotName, value: selectedVal });
            selectedVal = 0; // ÈÅ∏ÊäûËß£Èô§
        }

        // „Çø„Éº„É≥Ëß£Ê±∫ (Áô∫ÈÄ≤)
        async function resolveTurn() {
            if(!confirm("Áô∫ÈÄ≤„Åó„Åæ„Åô„ÅãÔºü (Ê©üÈñ¢Â£´„ÅÆÊ∫ñÂÇô„ÅØOK„Åß„Åô„ÅãÔºü)")) return;
            const res = await fetch(API + '?action=resolve').then(r=>r.json());
            alert(res.message); // ÁµêÊûúË°®Á§∫
            update();
        }

        // ÁîªÈù¢Êõ¥Êñ∞
        async function update() {
            if (lockUpdate) return;
            try {
                const s = await fetch(API).then(r => r.json()).then(d => d.state); // state„ÅÆ‰∏≠Ë∫´„ÇíÂèñÂæó

                // HUDÊõ¥Êñ∞
                document.getElementById('val-fuel').innerText = s.fuel;
                document.getElementById('val-dist').innerText = s.distance;
                document.getElementById('val-shield').innerText = s.shield;

                // „Çπ„É≠„ÉÉ„ÉàÊõ¥Êñ∞
                document.getElementById('slot-move').innerText = s.slot_move;
                document.getElementById('slot-energy').innerText = s.slot_energy;
                document.getElementById('slot-shield').innerText = s.slot_shield;

                // „ÉÄ„Ç§„ÇπÊèèÁîª
                renderDice('p', s.p_dice);
                renderDice('e', s.e_dice);

                // „Éú„Çø„É≥Âà∂Âæ°
                document.getElementById('btn-roll-p').disabled = (myRole !== 'pilot');
                document.getElementById('btn-roll-e').disabled = (myRole !== 'engineer');
                
                // ÈÖçÁΩÆ„Éú„Çø„É≥Âà∂Âæ° (ÈÅ∏Êäû‰∏≠„Åã„Å§Ëá™ÂàÜ„ÅÆÊãÖÂΩì„ÅÆ„Åø)
                const hasSel = (selectedVal !== 0);
                document.getElementById('btn-set-move').disabled = !(hasSel && myRole === 'pilot');
                document.getElementById('btn-set-energy').disabled = !(hasSel && myRole === 'engineer');
                document.getElementById('btn-set-shield').disabled = !(hasSel && myRole === 'engineer');

                // Áô∫ÈÄ≤„Éú„Çø„É≥Ë°®Á§∫ (ÊìçÁ∏¶Â£´„ÅÆ„Åø„ÄÅ„Åã„Å§ÁßªÂãï„Çπ„É≠„ÉÉ„Éà„Å´„ÉÄ„Ç§„Çπ„Åå„ÅÇ„ÇãÊôÇ)
                if (myRole === 'pilot' && s.slot_move > 0) {
                    document.getElementById('area-engage').classList.remove('hidden');
                } else {
                    document.getElementById('area-engage').classList.add('hidden');
                }

            } catch(e) { console.log(e); }
        }

        function renderDice(prefix, diceArr) {
            const area = document.getElementById(prefix + '-dice-area');
            area.innerHTML = '';
            const role = (prefix === 'p') ? 'pilot' : 'engineer';

            diceArr.forEach(val => {
                const d = document.createElement('div');
                d.className = 'dice';
                if (val === 0) d.classList.add('used');
                d.innerText = val || '-';
                
                // Ëá™ÂàÜ„ÅÆ„ÉÄ„Ç§„Çπ„ÅÆ„Åø„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ
                if (myRole === role && val !== 0) {
                    d.onclick = () => {
                        document.querySelectorAll('.dice').forEach(el => el.classList.remove('selected'));
                        d.classList.add('selected');
                        selectedVal = val;
                    };
                }
                area.appendChild(d);
            });
        }
    </script>
</body>
</html>

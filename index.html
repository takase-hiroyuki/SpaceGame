<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Silent Orbit (Minimal Fixed)</title>
    <style>
        .hidden { display: none; }
        .section { border: 1px solid black; margin: 5px; padding: 5px; }
    </style>
</head>
<body>

    <script>
        // ↓↓↓ ここにGASのURLを貼る ↓↓↓
        const API_URL = 'https://script.google.com/macros/s/AKfycbw19dV3WObyjGZDEXXqTA2G6PhitmvfbUXfyIe1qCYuzJ53-lnT_LhR5dZ1jlDHC9zV/exec';
    </script>

    <div id="lobby-screen" class="section">
        役割を選択　
        <button onclick="joinGame('pilot')">操縦士 (Pilot)</button>
        <button onclick="joinGame('engineer')">機関士 (Engineer)</button>
        <button onclick="joinGame('supervisor')">管理者 (SV)</button>
        <button onclick="joinGame('audience')">観戦 (Monitor)</button>
    </div>

    <div id="game-screen" class="section hidden">
        
        <div style="background-color: #eee; padding: 10px; border-bottom: 2px solid red;">            
            更新まで: <span id="timer-display" style="font-size:24px; color:blue; font-weight:bold;">--</span> 秒
            <span id="status-text" style="font-weight:bold;">待機中</span>
        </div>
        <div class="section">
            <span id="my-role-display">--</span> ・・・ 
            燃料: <span id="val-fuel">0</span> | 
            距離: <span id="val-dist">0</span> | 
            盾: <span id="val-shield">0</span>
        </div>

        <div class="section">
            [1] サイコロを振る
                <b>操縦士:</b> <span id="p-dice-view"></span>
                <button id="btn-roll-p" onclick="sendAction('roll', {role:'pilot'})" disabled>振る</button>　
                <b>機関士:</b> <span id="e-dice-view"></span>
                <button id="btn-roll-e" onclick="sendAction('roll', {role:'engineer'})" disabled>振る</button>　
                選択中の値: <b id="selected-val" color:red;">未選択</b>
        </div>

        <div class="section">
            [2] 配置する
            <button id="btn-set-move" onclick="placeDice('move')" disabled>移動へ置く (<span id="slot-move">0</span>)</button>
            <button id="btn-set-energy" onclick="placeDice('energy')" disabled>エネルギーへ置く (<span id="slot-energy">0</span>)</button>
            <button id="btn-set-shield" onclick="placeDice('shield')" disabled>修理へ置く (<span id="slot-shield">0</span>)</button>
        </div>
        <div id="engage-area" class="section hidden">
            <button onclick="resolveTurn()" style="font-size:12px;">★ 発進する (Engage) ★</button>
        </div>
        <div id="reset-area" class="section hidden">
            <button onclick="doReset()">【管理者】強制リセット</button>
        </div>
    </div>

    <script>
        let myRole = '';
        let selectedValue = 0;
        
        // ★修正：タイマー関連の変数
        let countdown = 0;       // 現在の残り秒数
        let intervalSec = 3;     // 基本の更新間隔（秒）
        let timerId = null;      // タイマー管理用

        // --- 1. 参加処理 ---
        async function joinGame(role) {
            // パスワード確認
            if (role === 'supervisor') {
                if (prompt("パスワード") !== "1234") return;
            }

            // プレイヤーの空席確認
            if (role === 'pilot' || role === 'engineer') {
                document.getElementById('status-text').innerText = "空席確認中...";
                try {
                    const res = await fetch(API_URL + '?action=join&role=' + role).then(r => r.json());
                    if (res.result === 'taken') {
                        alert("満席のため観戦します");
                        role = 'audience';
                    }
                } catch (e) {
                    alert("通信エラー: URLを確認してください");
                    return;
                }
            }

            // ★役割ごとの秒数設定
            myRole = role;
            if (myRole === 'audience') {
                intervalSec = 10; // 観戦者は10秒
            } else {
                intervalSec = 3;  // それ以外は3秒
            }

            // 画面切り替え
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('my-role-display').innerText = role + " (更新間隔: " + intervalSec + "秒)";
            
            if (role === 'supervisor') document.getElementById('reset-area').classList.remove('hidden');

            // ★タイマー開始
            updateData(); // 最初の一回を実行
            timerId = setInterval(timerLoop, 1000); // 1秒ごとにカウントダウン
        }

        // --- 2. タイマー処理（修正版） ---
        function timerLoop() {
            // カウントダウン
            countdown--;

            // 画面表示
            if (countdown < 0) countdown = 0;
            document.getElementById('timer-display').innerText = countdown;

            // 0になったら通信実行
            if (countdown <= 0) {
                updateData();
            }
        }

        // --- 3. データ送受信 ---
        async function updateData() {
            // 通信中は状態を表示
            document.getElementById('status-text').innerText = "データ受信中...";
            document.getElementById('status-text').style.color = "red";

            try {
                // GASからデータ取得
                const res = await fetch(API_URL).then(r => r.json());
                const s = res.state;

                // 画面更新
                document.getElementById('val-fuel').innerText = s.fuel;
                document.getElementById('val-dist').innerText = s.distance;
                document.getElementById('val-shield').innerText = s.shield;
                document.getElementById('slot-move').innerText = s.slot_move;
                document.getElementById('slot-energy').innerText = s.slot_energy;
                document.getElementById('slot-shield').innerText = s.slot_shield;

                // ダイス描画
                drawDice(s.p_dice, 'p-dice-view');
                drawDice(s.e_dice, 'e-dice-view');

                // 発進ボタン制御
                if (myRole === 'pilot' && s.slot_move > 0) {
                    document.getElementById('engage-area').classList.remove('hidden');
                } else {
                    document.getElementById('engage-area').classList.add('hidden');
                }

                updateButtons();

                // ★通信成功したら、タイマーをリセットして待機に戻る
                document.getElementById('status-text').innerText = "待機中";
                document.getElementById('status-text').style.color = "black";
                countdown = intervalSec; // ここで秒数を戻す
                document.getElementById('timer-display').innerText = countdown;

            } catch(e) {
                console.log(e);
                document.getElementById('status-text').innerText = "通信失敗(リトライ中)";
                countdown = 3; // エラー時は3秒後に再試行
            }
        }

        // --- 4. アクション送信 ---
        async function sendAction(actionName, params = {}) {
            document.getElementById('status-text').innerText = "送信中...";
            const qs = new URLSearchParams({ ...params, action: actionName }).toString();
            
            // 送信
            await fetch(API_URL + '?' + qs);
            
            // 送信後はすぐに画面更新したいのでカウントを0にする
            countdown = 0;
            document.getElementById('timer-display').innerText = 0;
        }

        // --- 5. ゲームロジック（ヘルパー関数） ---
        function drawDice(diceArray, elementId) {
            let html = "";
            diceArray.forEach(val => {
                if (val === 0) {
                    html += "[済] ";
                } else {
                    // 自分の値だけ選択可能にする
                    html += `<button onclick="selectValue(${val})">[ ${val} ]</button> `;
                }
            });
            document.getElementById(elementId).innerHTML = html;
        }

        function selectValue(val) {
            selectedValue = val;
            document.getElementById('selected-val').innerText = val;
            updateButtons();
        }

        function placeDice(slotName) {
            if (selectedValue === 0) return;
            sendAction('place', { slot: slotName, value: selectedValue });
            selectedValue = 0;
            document.getElementById('selected-val').innerText = "未選択";
        }

        function resolveTurn() {
            if(confirm("発進しますか？")) sendAction('resolve');
        }

        function doReset() {
            if(confirm("リセットしますか？")) sendAction('reset');
        }

        function updateButtons() {
            document.getElementById('btn-roll-p').disabled = (myRole !== 'pilot');
            document.getElementById('btn-roll-e').disabled = (myRole !== 'engineer');
            const hasSel = (selectedValue !== 0);
            document.getElementById('btn-set-move').disabled = !(hasSel && myRole === 'pilot');
            document.getElementById('btn-set-energy').disabled = !(hasSel && myRole === 'engineer');
            document.getElementById('btn-set-shield').disabled = !(hasSel && myRole === 'engineer');
        }
    </script>
</body>
</html>

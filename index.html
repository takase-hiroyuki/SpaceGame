<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silent Orbit</title>
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š --- */
        body { background-color: #050510; color: #0f0; font-family: 'Courier New', monospace; text-align: center; margin: 0; padding: 10px; user-select: none; }
        h1, h2 { margin: 5px 0; text-shadow: 0 0 5px #0f0; }
        .hidden { display: none !important; }
        .panel { border: 1px solid #0f0; border-radius: 8px; padding: 10px; margin: 10px auto; max-width: 600px; background: rgba(0, 30, 0, 0.4); }
        
        /* HUD */
        .hud-container { display: flex; justify-content: space-around; background: #001100; padding: 10px; border-bottom: 2px solid #0f0; }
        .hud-box { text-align: center; width: 30%; }
        .hud-label { font-size: 12px; color: #8f8; }
        .hud-val { font-size: 24px; font-weight: bold; color: #fff; }

        /* ãƒœã‚¿ãƒ³ */
        button { background: #003300; color: #0f0; border: 1px solid #0f0; padding: 10px; font-size: 16px; cursor: pointer; border-radius: 4px; margin: 5px; }
        button:disabled { border-color: #444; color: #444; background: #111; }
        button:active { background: #005500; }
        .btn-engage { background: #006600; color: #fff; font-weight: bold; width: 80%; padding: 15px; font-size: 20px; box-shadow: 0 0 10px #0f0; }
        .btn-engage:hover { background: #00aa00; }
        
        /* ãƒ€ã‚¤ã‚¹ */
        .dice-area { display: flex; justify-content: center; gap: 8px; margin: 10px 0; min-height: 50px; }
        .dice { width: 45px; height: 45px; line-height: 45px; border: 2px solid #0f0; font-size: 22px; background: #000; cursor: pointer; }
        .dice.selected { background: #0f0; color: #000; box-shadow: 0 0 10px #0f0; }
        .dice.used { border-color: #333; color: #333; cursor: default; }

        /* ã‚¹ãƒ­ãƒƒãƒˆ */
        .slot-row { display: flex; justify-content: space-around; margin-top: 10px; }
        .slot { border: 1px dashed #0a0; padding: 5px; width: 30%; min-height: 80px; position: relative; }
        .slot-title { font-size: 12px; color: #8f8; margin-bottom: 5px; }
        .slot-val { font-size: 28px; color: #fff; font-weight: bold; }
        .slot button { width: 90%; font-size: 12px; padding: 5px; }
    </style>
</head>
<body>

    <script>
        // â†“â†“â†“ ã“ã“ã« GASã®URL ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â†“â†“â†“
        const API_URL = 'https://script.google.com/macros/s/AKfycbw19dV3WObyjGZDEXXqTA2G6PhitmvfbUXfyIe1qCYuzJ53-lnT_LhR5dZ1jlDHC9zV/exec';
        // â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘
    </script>
    <div id="lobby" class="panel">
        <h1>SILENT ORBIT</h1>
        <p>COOPERATIVE SPACE MISSION</p>
        <hr style="border-color:#030;">
        <button onclick="join('pilot')">ğŸ‘¨â€ğŸš€ PILOT</button>
        <button onclick="join('engineer')">ğŸ”§ ENGINEER</button>
        <br><br>
        <button onclick="join('supervisor')">ğŸ‘‘ SUPERVISOR (PW)</button>
        <button onclick="join('audience')">ğŸ‘€ MONITOR</button>
    </div>

    <div id="game" class="hidden">
        <div class="hud-container">
            <div class="hud-box"><div class="hud-label">FUEL</div><div id="val-fuel" class="hud-val">5</div></div>
            <div class="hud-box"><div class="hud-label">DIST</div><div id="val-dist" class="hud-val">0</div></div>
            <div class="hud-box"><div class="hud-label">SHIELD</div><div id="val-shield" class="hud-val">3</div></div>
        </div>

        <div style="font-size:12px; text-align:right; color:#888; padding:2px;">
            ROLE: <span id="disp-role" style="color:#fff; font-weight:bold;">-</span>
        </div>

        <div class="panel">
            <div style="text-align:left; color:#0f0;">â–  PILOT DECK</div>
            <div id="p-dice-area" class="dice-area"></div>
            <button id="btn-roll-p" onclick="act('roll', {role:'pilot'})" disabled>ğŸ² ROLL</button>

            <hr style="border-color:#030; margin:15px 0;">

            <div style="text-align:left; color:#0f0;">â–  ENGINEER DECK</div>
            <div id="e-dice-area" class="dice-area"></div>
            <button id="btn-roll-e" onclick="act('roll', {role:'engineer'})" disabled>ğŸ² ROLL</button>
        </div>

        <div class="panel">
            <div style="color:#ff0; font-size:14px; margin-bottom:5px;">SYSTEM SLOTS</div>
            <div class="slot-row">
                <div class="slot">
                    <div class="slot-title">ğŸš€ THRUSTER</div>
                    <div id="slot-move" class="slot-val">0</div>
                    <button id="btn-set-move" onclick="place('move')" disabled>SET</button>
                </div>
                <div class="slot">
                    <div class="slot-title">âš¡ REACTOR</div>
                    <div id="slot-energy" class="slot-val">0</div>
                    <button id="btn-set-energy" onclick="place('energy')" disabled>SET</button>
                </div>
                <div class="slot">
                    <div class="slot-title">ğŸ›¡ REPAIR</div>
                    <div id="slot-shield" class="slot-val">0</div>
                    <button id="btn-set-shield" onclick="place('shield')" disabled>SET</button>
                </div>
            </div>
        </div>

        <div id="area-engage" class="panel hidden" style="border-color:yellow;">
            <p style="color:yellow; font-size:12px; margin:0;">SYSTEM READY</p>
            <button class="btn-engage" onclick="resolveTurn()">ğŸš€ ENGAGE (ç™ºé€²)</button>
        </div>

        <button id="btn-reset" class="hidden" onclick="doReset()" style="background:#500; color:#faa; width:100%;">âš  EMERGENCY RESET</button>
    </div>

    <script>
        let myRole = '';
        let selectedVal = 0;
        let lockUpdate = false;

        // å‚åŠ å‡¦ç†
        async function join(role) {
            // SVã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
            if (role === 'supervisor') {
                if (prompt("Password?") !== "1234") return;
            }

            // æ“ç¸¦å£«ãƒ»æ©Ÿé–¢å£«ã®å ´åˆã€ç©ºãçŠ¶æ³ã‚’å•ã„åˆã‚ã›ã‚‹
            // â˜…URLãŒé–“é•ã£ã¦ã„ã‚‹ã¨ã“ã“ã§æ­¢ã¾ã‚Šã¾ã™
            if (role === 'pilot' || role === 'engineer') {
                try {
                    const res = await fetch(API_URL + '?action=join&role=' + role).then(r=>r.json());
                    if (res.result === 'taken') {
                        alert("ãã®å¸­ã¯æ—¢ã«åŸ‹ã¾ã£ã¦ã„ã¾ã™ã€‚è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚");
                        role = 'audience';
                    }
                } catch(e) {
                    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: URLè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„\n" + e);
                    return;
                }
            }
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            myRole = role;
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            document.getElementById('disp-role').innerText = role.toUpperCase();
            
            // SVãªã‚‰ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            if (role === 'supervisor') {
                document.getElementById('btn-reset').classList.remove('hidden');
            }

            // å®šæœŸæ›´æ–°é–‹å§‹ (2ç§’ã”ã¨)
            setInterval(update, 2000);
            update();
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡
        async function act(action, params = {}) {
            lockUpdate = true;
            const qs = new URLSearchParams({ ...params, action: action }).toString();
            await fetch(API_URL + '?' + qs);
            lockUpdate = false;
            update();
        }

        // é…ç½®å‡¦ç†
        function place(slotName) {
            if (selectedVal === 0) return;
            act('place', { slot: slotName, value: selectedVal });
            selectedVal = 0;
        }

        // ã‚¿ãƒ¼ãƒ³è§£æ±º
        async function resolveTurn() {
            if(!confirm("ç™ºé€²ã—ã¾ã™ã‹ï¼Ÿ (æ©Ÿé–¢å£«ã®æº–å‚™ã¯OKã§ã™ã‹ï¼Ÿ)")) return;
            const res = await fetch(API_URL + '?action=resolve').then(r=>r.json());
            alert(res.message);
            update();
        }

        // â˜…ä¿®æ­£ç‰ˆï¼šãƒªã‚»ãƒƒãƒˆå‡¦ç†
        async function doReset() {
            if (!confirm("ã€è­¦å‘Šã€‘\næœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nå…¨å“¡ã®ã‚²ãƒ¼ãƒ ãŒåˆæœŸçŠ¶æ…‹ã«æˆ»ã‚Šã¾ã™ã€‚")) return;
            await act('reset');
            alert("ãƒªã‚»ãƒƒãƒˆå®Œäº†ã—ã¾ã—ãŸï¼");
            update();
        }

        // ç”»é¢æ›´æ–°
        async function update() {
            if (lockUpdate) return;
            try {
                const s = await fetch(API_URL).then(r => r.json()).then(d => d.state);

                // HUDæ›´æ–°
                document.getElementById('val-fuel').innerText = s.fuel;
                document.getElementById('val-dist').innerText = s.distance;
                document.getElementById('val-shield').innerText = s.shield;

                // ã‚¹ãƒ­ãƒƒãƒˆæ›´æ–°
                document.getElementById('slot-move').innerText = s.slot_move;
                document.getElementById('slot-energy').innerText = s.slot_energy;
                document.getElementById('slot-shield').innerText = s.slot_shield;

                // ãƒ€ã‚¤ã‚¹æç”»
                renderDice('p', s.p_dice);
                renderDice('e', s.e_dice);

                // ãƒœã‚¿ãƒ³åˆ¶å¾¡
                document.getElementById('btn-roll-p').disabled = (myRole !== 'pilot');
                document.getElementById('btn-roll-e').disabled = (myRole !== 'engineer');
                
                const hasSel = (selectedVal !== 0);
                document.getElementById('btn-set-move').disabled = !(hasSel && myRole === 'pilot');
                document.getElementById('btn-set-energy').disabled = !(hasSel && myRole === 'engineer');
                document.getElementById('btn-set-shield').disabled = !(hasSel && myRole === 'engineer');

                // ç™ºé€²ãƒœã‚¿ãƒ³è¡¨ç¤º
                if (myRole === 'pilot' && s.slot_move > 0) {
                    document.getElementById('area-engage').classList.remove('hidden');
                } else {
                    document.getElementById('area-engage').classList.add('hidden');
                }

            } catch(e) { console.log(e); }
        }

        function renderDice(prefix, diceArr) {
            const area = document.getElementById(prefix + '-dice-area');
            area.innerHTML = '';
            const role = (prefix === 'p') ? 'pilot' : 'engineer';

            diceArr.forEach(val => {
                const d = document.createElement('div');
                d.className = 'dice';
                if (val === 0) d.classList.add('used');
                d.innerText = val || '-';
                
                if (myRole === role && val !== 0) {
                    d.onclick = () => {
                        document.querySelectorAll('.dice').forEach(el => el.classList.remove('selected'));
                        d.classList.add('selected');
                        selectedVal = val;
                    };
                }
                area.appendChild(d);
            });
        }
    </script>
</body>
</html>

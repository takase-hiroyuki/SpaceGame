<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Silent Orbit (Minimal)</title>
    <style>
        .hidden { display: none; }
        /* わかりやすくするために、エリアごとに少し枠線だけつけます */
        .section { border: 1px solid black; margin: 10px; padding: 10px; }
    </style>
</head>
<body>

    <script>
        // ↓↓↓ ここにGASのURLを貼る ↓↓↓
        const API_URL = 'https://script.google.com/macros/s/AKfycbw19dV3WObyjGZDEXXqTA2G6PhitmvfbUXfyIe1qCYuzJ53-lnT_LhR5dZ1jlDHC9zV/exec';
    </script>

    <div id="lobby-screen" class="section">
        <h2>役割を選択してください</h2>
        <button onclick="joinGame('pilot')">操縦士 (Pilot)</button>
        <button onclick="joinGame('engineer')">機関士 (Engineer)</button>
        <button onclick="joinGame('supervisor')">管理者 (SV)</button>
        <button onclick="joinGame('audience')">観戦 (Monitor)</button>
    </div>

    <div id="game-screen" class="section hidden">
        
        <div style="background-color: #eee; padding: 5px;">
            状態: <span id="status-text">待機中</span>
            (更新まで: <span id="timer-display" style="font-weight:bold; font-size:20px; color:red;">3</span> 秒)
        </div>

        <h3>あなたの役割: <span id="my-role-display">--</span></h3>

        <div class="section">
            燃料(Fuel): <span id="val-fuel">0</span> | 
            距離(Dist): <span id="val-dist">0</span> | 
            盾(Shield): <span id="val-shield">0</span>
        </div>

        <div class="section">
            <h4>[1] サイコロを振る</h4>
            
            <div>
                <b>操縦士:</b> 
                <span id="p-dice-view"></span>
                <button id="btn-roll-p" onclick="sendAction('roll', {role:'pilot'})" disabled>振る</button>
            </div>
            
            <div>
                <b>機関士:</b> 
                <span id="e-dice-view"></span>
                <button id="btn-roll-e" onclick="sendAction('roll', {role:'engineer'})" disabled>振る</button>
            </div>
            
            <p>※自分のサイコロの数字をクリックして選択してください: <b id="selected-val">未選択</b></p>
        </div>

        <div class="section">
            <h4>[2] 配置する (Set)</h4>
            
            <button id="btn-set-move" onclick="placeDice('move')" disabled>
                移動スロットへ置く (現在: <span id="slot-move">0</span>)
            </button>
            <br><br>
            
            <button id="btn-set-energy" onclick="placeDice('energy')" disabled>
                エネルギースロットへ置く (現在: <span id="slot-energy">0</span>)
            </button>
            <br><br>
            
            <button id="btn-set-shield" onclick="placeDice('shield')" disabled>
                修理スロットへ置く (現在: <span id="slot-shield">0</span>)
            </button>
        </div>

        <div id="engage-area" class="section hidden">
            <button onclick="resolveTurn()">★ 発進する (Engage) ★</button>
        </div>

        <div id="reset-area" class="section hidden">
            <button onclick="doReset()">【管理者用】強制リセット</button>
        </div>

    </div>

    <script>
        let myRole = '';
        let selectedValue = 0;
        let countdown = 3;  // カウントダウン初期値

        // --- 1. 参加処理 ---
        async function joinGame(role) {
            // SVのパスワード
            if (role === 'supervisor') {
                if (prompt("パスワードは？") !== "1234") return;
            }

            // プレイヤーなら空き状況確認
            if (role === 'pilot' || role === 'engineer') {
                document.getElementById('status-text').innerText = "空席確認中...";
                try {
                    const res = await fetch(API_URL + '?action=join&role=' + role).then(r => r.json());
                    if (res.result === 'taken') {
                        alert("満席です。観戦します。");
                        role = 'audience';
                    }
                } catch (e) {
                    alert("URLが間違っているか、通信エラーです");
                    return;
                }
            }

            // 画面切り替え
            myRole = role;
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('my-role-display').innerText = role;

            // SVならリセットボタン表示
            if (role === 'supervisor') document.getElementById('reset-area').classList.remove('hidden');

            // ★カウントダウンタイマー開始 (1秒ごとに実行)
            setInterval(timerLoop, 1000);
            
            // 初回更新
            updateData();
        }

        // --- 2. カウントダウンと定期更新の仕組み ---
        function timerLoop() {
            // カウントを減らす
            countdown--;
            
            // 画面に表示
            if (countdown < 0) countdown = 0;
            document.getElementById('timer-display').innerText = countdown;

            // 0になったら通信開始
            if (countdown <= 0) {
                updateData();
                countdown = 4; // 通信時間を考慮して4秒後にリセット
            }
        }

        // --- 3. データ送受信 (通信機能) ---
        async function updateData() {
            document.getElementById('status-text').innerText = "通信中...";
            document.getElementById('status-text').style.color = "red";

            try {
                // GASからデータを取得
                const res = await fetch(API_URL).then(r => r.json());
                const s = res.state;

                // 画面を書き換え
                document.getElementById('val-fuel').innerText = s.fuel;
                document.getElementById('val-dist').innerText = s.distance;
                document.getElementById('val-shield').innerText = s.shield;
                
                document.getElementById('slot-move').innerText = s.slot_move;
                document.getElementById('slot-energy').innerText = s.slot_energy;
                document.getElementById('slot-shield').innerText = s.slot_shield;

                // サイコロ表示の更新
                drawDice(s.p_dice, 'p-dice-view');
                drawDice(s.e_dice, 'e-dice-view');

                // 発進ボタンの表示制御
                if (myRole === 'pilot' && s.slot_move > 0) {
                    document.getElementById('engage-area').classList.remove('hidden');
                } else {
                    document.getElementById('engage-area').classList.add('hidden');
                }

                // ボタンの有効/無効切り替え
                updateButtons();

                // 通信完了表示
                document.getElementById('status-text').innerText = "待機中";
                document.getElementById('status-text').style.color = "black";

            } catch(e) {
                console.log(e);
                document.getElementById('status-text').innerText = "エラー発生";
            }
        }

        // --- 4. アクション送信 ---
        async function sendAction(actionName, params = {}) {
            document.getElementById('status-text').innerText = "送信中...";
            
            // URLを作る
            const qs = new URLSearchParams({ ...params, action: actionName }).toString();
            
            // 送信する
            await fetch(API_URL + '?' + qs);
            
            // すぐに画面更新
            countdown = 1; // すぐ更新されるようにタイマーを短くする
        }

        // --- 5. ゲームロジック ---
        
        // サイコロの描画
        function drawDice(diceArray, elementId) {
            let html = "";
            diceArray.forEach(val => {
                if (val === 0) {
                    html += "[済] ";
                } else {
                    // クリックしたら selectValue() が動くようにする
                    html += `<button onclick="selectValue(${val})">[ ${val} ]</button> `;
                }
            });
            document.getElementById(elementId).innerHTML = html;
        }

        // サイコロを選んだとき
        function selectValue(val) {
            // 自分の役割のサイコロかどうかのチェックは省略（学習用のためシンプルに）
            selectedValue = val;
            document.getElementById('selected-val').innerText = val;
            updateButtons();
        }

        // スロットに置く
        function placeDice(slotName) {
            if (selectedValue === 0) return;
            sendAction('place', { slot: slotName, value: selectedValue });
            selectedValue = 0; // 選択リセット
            document.getElementById('selected-val').innerText = "未選択";
        }

        // ターン解決
        function resolveTurn() {
            if(confirm("発進しますか？")) {
                sendAction('resolve');
            }
        }

        // リセット
        function doReset() {
            if(confirm("リセットしますか？")) {
                sendAction('reset');
            }
        }

        // ボタンの有効化・無効化制御
        function updateButtons() {
            // ロールボタン
            document.getElementById('btn-roll-p').disabled = (myRole !== 'pilot');
            document.getElementById('btn-roll-e').disabled = (myRole !== 'engineer');

            // 配置ボタン (値を選択していて、かつ自分の役割のときだけ押せる)
            const hasSel = (selectedValue !== 0);
            document.getElementById('btn-set-move').disabled = !(hasSel && myRole === 'pilot');
            document.getElementById('btn-set-energy').disabled = !(hasSel && myRole === 'engineer');
            document.getElementById('btn-set-shield').disabled = !(hasSel && myRole === 'engineer');
        }
    </script>
</body>
</html>

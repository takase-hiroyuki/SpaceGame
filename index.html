<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Silent Orbit (Fixed v2)</title>
    <style>
        .hidden { display: none; }
        .section { border: 1px solid black; margin: 5px; padding: 5px; }
        /* 自分のダイスではない時の見た目 */
        .dice-view { padding: 2px 5px; background: #eee; border: 1px solid #ccc; margin: 0 2px; }
    </style>
</head>
<body>

    <script>
        // ↓↓↓ ここにGASのURLを貼る ↓↓↓
        const API_URL = 'https://script.google.com/macros/s/AKfycbw19dV3WObyjGZDEXXqTA2G6PhitmvfbUXfyIe1qCYuzJ53-lnT_LhR5dZ1jlDHC9zV/exec';
    </script>

    <div id="lobby-screen" class="section">
        役割選択　
        <button onclick="joinGame('pilot')">操縦士 (Pilot)</button>
        <button onclick="joinGame('engineer')">機関士 (Engineer)</button>
        <button onclick="joinGame('supervisor')">管理者 (SV)</button>
        <button onclick="joinGame('audience')">観戦 (Monitor)</button>
    </div>

    <div id="game-screen" class="section hidden">
        
        <div style="background-color: #eee; padding: 10px; border-bottom: 2px solid red;">            
            更新まで: <span id="timer-display" style="font-size:24px; color:blue; font-weight:bold;">--</span> 秒
            <span id="status-text" style="font-weight:bold;">待機中</span>
        </div>
        <div class="section">
            <span id="my-role-display">--</span> ・・・ 
            燃料: <span id="val-fuel">0</span> | 
            距離: <span id="val-dist">0</span> | 
            盾: <span id="val-shield">0</span>
        </div>

        <div class="section">
            [1] サイコロを振る
                <b>操縦士:</b> <span id="p-dice-view"></span>
                <button id="btn-roll-p" onclick="sendAction('roll', {role:'pilot'})" disabled>振る</button>　
                
                <b>機関士:</b> <span id="e-dice-view"></span>
                <button id="btn-roll-e" onclick="sendAction('roll', {role:'engineer'})" disabled>振る</button>　
                
                選択中の値: <b id="selected-val" style="color:red;">未選択</b>
        </div>

        <div class="section">
            [2] 配置する
            <button id="btn-set-move" onclick="placeDice('move')" disabled>移動へ置く (<span id="slot-move">0</span>)</button>
            <button id="btn-set-energy" onclick="placeDice('energy')" disabled>エネルギーへ置く (<span id="slot-energy">0</span>)</button>
            <button id="btn-set-shield" onclick="placeDice('shield')" disabled>修理へ置く (<span id="slot-shield">0</span>)</button>
        </div>
        <div id="engage-area" class="section hidden">
            <button onclick="resolveTurn()" style="font-size:12px;">★ 発進する (Engage) ★</button>
        </div>
        <div id="reset-area" class="section hidden">
            <button onclick="doReset()">【管理者】強制リセット</button>
        </div>
    </div>

    <script>
        let myRole = '';
        let selectedValue = 0;
        
        let countdown = 0;
        let intervalSec = 3;
        let timerId = null;

        // --- 1. 参加処理 ---
        async function joinGame(role) {
            if (role === 'supervisor') {
                if (prompt("パスワード") !== "1234") return;
            }

            if (role === 'pilot' || role === 'engineer') {
                document.getElementById('status-text').innerText = "空席確認中...";
                try {
                    const res = await fetch(API_URL + '?action=join&role=' + role).then(r => r.json());
                    if (res.result === 'taken') {
                        alert("満席のため観戦します");
                        role = 'audience';
                    }
                } catch (e) {
                    alert("通信エラー: URLを確認してください");
                    return;
                }
            }

            myRole = role;
            // ★観戦者は10秒、プレイヤーは3秒
            if (myRole === 'audience') {
                intervalSec = 10;
            } else {
                intervalSec = 3;
            }

            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('my-role-display').innerText = role + " (更新間隔: " + intervalSec + "秒)";
            
            if (role === 'supervisor') document.getElementById('reset-area').classList.remove('hidden');

            // 初回実行
            updateData(); 
        }

        // --- 2. タイマー処理（バグ修正版） ---
        function startTimer() {
            // すでにタイマーが動いていたら止める（二重起動防止）
            if (timerId) clearInterval(timerId);
            
            countdown = intervalSec;
            document.getElementById('timer-display').innerText = countdown;

            timerId = setInterval(() => {
                countdown--;
                document.getElementById('timer-display').innerText = countdown;

                if (countdown <= 0) {
                    // ★0になったらタイマーを止めて、通信する
                    clearInterval(timerId);
                    updateData();
                }
            }, 1000);
        }

        // --- 3. データ送受信 ---
        async function updateData() {
            document.getElementById('status-text').innerText = "データ受信中...";
            document.getElementById('status-text').style.color = "red";

            try {
                const res = await fetch(API_URL).then(r => r.json());
                const s = res.state;

                document.getElementById('val-fuel').innerText = s.fuel;
                document.getElementById('val-dist').innerText = s.distance;
                document.getElementById('val-shield').innerText = s.shield;
                document.getElementById('slot-move').innerText = s.slot_move;
                document.getElementById('slot-energy').innerText = s.slot_energy;
                document.getElementById('slot-shield').innerText = s.slot_shield;

                // ★修正: 持ち主の情報('pilot'/'engineer')を渡す
                drawDice(s.p_dice, 'p-dice-view', 'pilot');
                drawDice(s.e_dice, 'e-dice-view', 'engineer');

                if (myRole === 'pilot' && s.slot_move > 0) {
                    document.getElementById('engage-area').classList.remove('hidden');
                } else {
                    document.getElementById('engage-area').classList.add('hidden');
                }

                updateButtons();

                document.getElementById('status-text').innerText = "待機中";
                document.getElementById('status-text').style.color = "black";
                
                // ★通信が終わったらタイマー再開
                startTimer();

            } catch(e) {
                console.log(e);
                document.getElementById('status-text').innerText = "再試行中...";
                // エラー時もタイマー再開
                startTimer();
            }
        }

        // --- 4. アクション送信 ---
        async function sendAction(actionName, params = {}) {
            // 送信時はタイマーを止める
            if (timerId) clearInterval(timerId);
            document.getElementById('status-text').innerText = "送信中...";
            
            const qs = new URLSearchParams({ ...params, action: actionName }).toString();
            await fetch(API_URL + '?' + qs);
            
            // 送信後はすぐに更新
            updateData();
        }

        // --- 5. ゲームロジック ---
        
        // ★修正: ownerRole（誰のダイスか）を受け取る
        function drawDice(diceArray, elementId, ownerRole) {
            let html = "";
            diceArray.forEach(val => {
                if (val === 0) {
                    html += "[済] ";
                } else {
                    // ★修正: 自分の役割と持ち主が一致するときだけボタンにする
                    if (myRole === ownerRole) {
                        html += `<button onclick="selectValue(${val})">[ ${val} ]</button> `;
                    } else {
                        // 相手のダイスは見せるだけ（クリック不可）
                        html += `<span class="dice-view">[ ${val} ]</span> `;
                    }
                }
            });
            document.getElementById(elementId).innerHTML = html;
        }

        function selectValue(val) {
            selectedValue = val;
            document.getElementById('selected-val').innerText = val;
            updateButtons();
        }

        function placeDice(slotName) {
            if (selectedValue === 0) return;
            sendAction('place', { slot: slotName, value: selectedValue });
            selectedValue = 0;
            document.getElementById('selected-val').innerText = "未選択";
        }

        function resolveTurn() {
            if(confirm("発進しますか？")) sendAction('resolve');
        }

        function doReset() {
            if(confirm("リセットしますか？")) sendAction('reset');
        }

        function updateButtons() {
            document.getElementById('btn-roll-p').disabled = (myRole !== 'pilot');
            document.getElementById('btn-roll-e').disabled = (myRole !== 'engineer');
            const hasSel = (selectedValue !== 0);
            document.getElementById('btn-set-move').disabled = !(hasSel && myRole === 'pilot');
            document.getElementById('btn-set-energy').disabled = !(hasSel && myRole === 'engineer');
            document.getElementById('btn-set-shield').disabled = !(hasSel && myRole === 'engineer');
        }
    </script>
</body>
</html>
